# zGameServer

一个基于Go语言开发的MMO游戏服务器框架，采用模块化设计，具有良好的可扩展性和性能。

## 项目特点

- **模块化设计**：清晰的代码结构，便于维护和扩展
- **多数据库支持**：支持MySQL和MongoDB数据库
- **异步数据库操作**：所有数据库操作均为异步，提高服务器性能
- **配置化管理**：通过配置文件和Excel表格管理服务器参数和游戏数据
- **完善的日志系统**：使用zap日志框架，支持不同级别日志输出
- **协议缓冲区**：使用Protocol Buffers进行高效的网络通信
- **安全机制**：账号密码验证、角色数据保护
- **崩溃恢复**：服务器崩溃时自动捕获堆栈信息并记录到日志
- **组件系统**：基于组件的游戏对象管理，提供高度的灵活性和可扩展性

## 技术栈

- **语言**：Go 1.25.5
- **网络**：TCP和HTTP协议，Protocol Buffers
- **数据库**：MySQL、MongoDB
- **日志**：zap日志框架
- **配置**：ini配置文件，Excel表格
- **依赖管理**：Go Modules

## 项目结构

```
zGameServer/
├── client/                 # 客户端测试代码
├── config/                 # 配置管理
│   ├── models/             # 配置模型
│   ├── tables/             # Excel配置表管理
│   └── ini_config.go       # ini配置文件管理
├── db/                     # 数据库相关代码
│   ├── connector/          # 数据库连接器
│   ├── dao/                # 数据访问对象
│   ├── models/             # 数据模型
│   └── db.go               # 数据库管理器
├── event/                  # 事件系统
├── game/                   # 游戏核心逻辑
│   ├── auction/            # 拍卖行系统
│   ├── common/             # 公共接口和工具
│   ├── guild/              # 公会系统
│   ├── maps/               # 地图系统
│   ├── monsters/           # 怪物系统
│   ├── npc/                # NPC系统
│   ├── object/             # 游戏对象系统
│   │   └── component/      # 组件系统
│   ├── pets/               # 宠物系统
│   ├── player/             # 玩家系统
│   └── systems/            # 核心游戏系统
│       ├── combat/         # 战斗系统
│       ├── movement/       # 移动系统
│       ├── property/       # 属性系统
│       └── skill/          # 技能系统
├── gameserver/             # 服务器核心
├── net/                    # 网络相关代码
│   ├── handler/            # 请求处理器
│   ├── protocol/           # 协议定义
│   ├── protolayer/         # 协议层实现
│   ├── router/             # 路由管理
│   └── service/            # 网络服务
├── resources/              # 资源文件
│   ├── excel_tables/       # Excel配置表
│   └── maps/               # 地图资源
├── config.ini              # 配置文件
├── go.mod                  # Go模块依赖
├── go.sum                  # 依赖校验
└── main.go                 # 主入口文件
```

## 核心功能模块

### 1. 网络服务
- TCP服务，处理客户端实时连接
- HTTP服务，处理非实时请求（如登录、注册）
- 数据包路由和处理
- 会话管理
- 支持多种协议格式（Protobuf、JSON、XML）

### 2. 游戏对象系统
- **GameObject**：基础游戏对象，包含ID、名称、位置等基本属性
- **LivingObject**：生命对象，继承自GameObject，增加生命值等属性
- **Component**：组件系统，允许动态为游戏对象添加功能
- **ComponentManager**：组件管理器，负责组件的添加、移除和管理

### 3. 玩家系统
- 账号创建和登录
- 角色创建、删除和选择
- **PlayerInventory**：玩家背包系统，管理物品
- **PlayerEquipment**：玩家装备系统，管理装备
- **PlayerSkill**：玩家技能系统，管理技能
- **PlayerTask**：玩家任务系统，管理任务
- **PlayerMailbox**：玩家邮箱系统，管理邮件

### 4. 怪物和NPC系统
- **Monster**：怪物对象，包含AI行为、掉落配置
- **NPC**：非玩家角色，包含对话、交互逻辑
- **AIBehavior**：AI行为系统，处理怪物和NPC的智能行为

### 5. 宠物系统
- **Pet**：宠物对象，包含成长、亲密度系统
- **PetGrowthSystem**：宠物成长系统，管理宠物等级、经验
- **IntimacySystem**：宠物亲密度系统，管理宠物与玩家的关系

### 6. 核心游戏系统
- **CombatSystem**：战斗核心系统，处理战斗计算、仇恨管理
- **MovementSystem**：移动系统，处理游戏对象的移动
- **PropertySystem**：属性系统，管理游戏对象的属性
- **SkillSystem**：技能系统，处理技能释放、冷却管理

### 7. 全局系统
- **GuildSystem**：公会系统，处理公会创建、管理
- **AuctionSystem**：拍卖行系统，处理物品拍卖
- **MapSystem**：地图系统，处理地图加载、管理

### 8. 数据库模块
- 多数据库连接管理
- 异步数据库操作
- 数据模型定义
- 数据访问对象（DAO）

### 9. 配置系统
- **ini配置**：服务器基本配置，如端口、数据库连接等
- **Excel配置表**：游戏数据配置，如物品、技能、怪物等
- 支持热更新配置，无需重启服务器

### 10. 日志系统
- 服务器运行日志
- 登录登出日志
- 错误和崩溃日志

## 配置文件

### 1. ini配置文件

`config.ini`：服务器基本配置，包括：
- 服务器基本配置（监听地址、端口、最大连接数等）
- 日志配置（级别、路径、文件大小等）
- 数据库配置（MySQL和MongoDB连接信息）

### 2. Excel配置表

`resources/excel_tables/`：游戏数据配置，包括：
- `item.xlsx`：物品配置
- `skill.xlsx`：技能配置
- `monster.xlsx`：怪物配置
- `npc.xlsx`：NPC配置
- `pet.xlsx`：宠物配置
- `guild.xlsx`：公会配置
- `quest.xlsx`：任务配置
- `map.xlsx`：地图配置
- `shop.xlsx`：商店配置
- `player_level.xlsx`：玩家等级配置

## 快速开始

### 1. 环境要求

- Go 1.16+ 或更高版本
- MySQL 5.7+ 或更高版本
- MongoDB 4.0+ 或更高版本（可选）

### 2. 安装依赖

```bash
go mod download
```

### 3. 配置数据库

1. 创建数据库：
   - MySQL：创建账号、游戏和日志数据库
   - MongoDB：创建游戏数据库（可选）

2. 在`config.ini`中配置数据库连接信息

### 4. 配置Excel表格

- 确保`resources/excel_tables/`目录下有所有必要的Excel配置表
- 根据游戏需求修改配置表内容

### 5. 编译和运行

```bash
# 编译
go build -o gameserver main.go

# 运行
./gameserver
```

### 6. 客户端测试

```bash
go run client/testclient.go
```

## 开发指南

### 1. 添加新功能模块

1. **系统设计**：
   - 在`game/`目录下创建新的系统目录
   - 遵循现有系统的设计模式，如`game/guild/`或`game/auction/`

2. **系统实现**：
   - 实现系统核心逻辑
   - 提供必要的接口供其他系统调用
   - 注册系统到游戏服务器

3. **配置管理**：
   - 如需配置，在`config/models/`和`config/tables/`中添加对应配置
   - 在`resources/excel_tables/`中添加对应Excel表格

4. **网络协议**：
   - 在`net/protocol/game.proto`中添加新的消息类型
   - 修改后执行`protoc --go_out=. net/protocol/game.proto`生成Go代码

5. **处理器实现**：
   - 在`net/handler/`中添加对应的消息处理器
   - 在`net/router/`中注册处理器

### 2. 扩展现有系统

1. **组件扩展**：
   - 利用组件系统，为游戏对象添加新组件
   - 在`game/object/component/`中创建新组件

2. **系统功能扩展**：
   - 为现有系统添加新功能
   - 遵循现有代码风格和架构模式

3. **数据库扩展**：
   - 在`db/models/`中添加新的数据库模型
   - 在`db/dao/`中添加对应的数据访问方法

### 3. 网络协议开发

1. **定义协议**：
   - 在`net/protocol/game.proto`中定义新的消息类型
   - 使用Protobuf语法定义消息结构

2. **生成代码**：
   - 执行`protoc --go_out=. net/protocol/game.proto`生成Go代码

3. **实现处理器**：
   - 在`net/handler/`中实现消息处理器
   - 处理客户端请求并返回响应

## 测试

运行测试：

```bash
go test ./...
```

## 日志

日志文件默认输出到控制台，可根据配置文件修改为输出到文件。

## 安全

### 1. 网络安全
- 验证所有客户端输入，防止注入攻击
- 使用加密传输敏感数据
- 限制客户端请求频率，防止DoS攻击

### 2. 数据库安全
- 使用参数化查询，防止SQL注入
- 数据库密码等敏感信息通过配置文件管理，不硬编码
- 定期备份数据库

### 3. 服务器安全
- 限制服务器端口访问
- 定期更新服务器软件
- 监控服务器状态，及时发现异常

## 性能优化

### 1. 网络优化
- 使用连接池管理网络连接
- 优化协议结构，减少数据传输量
- 使用压缩算法减少数据包大小

### 2. 内存优化
- 合理使用对象池，减少GC压力
- 避免频繁的内存分配和释放
- 使用适当的数据结构，平衡内存使用和性能

### 3. 数据库优化
- 使用索引优化数据库查询
- 合理设计数据库表结构
- 使用缓存减少数据库访问

### 4. 并发优化
- 合理使用goroutine，避免过度并发
- 使用适当的同步机制，避免竞态条件
- 优化锁的粒度，减少锁竞争

## 注意事项

### 1. 代码规范
- **命名规范**：
  - 包名：小写，使用简短的名词
  - 函数名：驼峰命名，首字母大写表示可导出
  - 变量名：驼峰命名，首字母小写表示私有

- **代码风格**：
  - 遵循Go语言标准代码风格
  - 使用`go fmt`格式化代码
  - 代码注释清晰，解释关键逻辑

### 2. 常见问题

- **网络连接问题**：
  - 检查网络配置和防火墙设置
  - 确保客户端和服务器使用相同的协议版本

- **数据库连接问题**：
  - 检查数据库配置是否正确
  - 确保数据库服务已启动
  - 检查数据库用户权限

- **性能问题**：
  - 检查服务器资源使用情况
  - 优化代码逻辑，减少不必要的计算
  - 使用性能分析工具定位瓶颈

- **配置问题**：
  - 确保配置文件格式正确
  - 检查配置项是否完整
  - 注意配置文件的大小写敏感问题

## 未来规划

- 支持更多游戏类型和玩法
- 提供更多工具和脚本，简化开发流程
- 增强监控和运维工具，提高服务器稳定性
- 支持更多平台和设备，扩大应用范围
- 分布式服务器支持
- 负载均衡
- 热更新功能
- 监控系统

## 贡献

欢迎提交Issue和Pull Request！

## 许可证

MIT License
