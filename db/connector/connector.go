package connector

import (
	"database/sql"
	"sync"

	"github.com/pzqf/zEngine/zLog"
	"github.com/pzqf/zGameServer/config"
	"go.mongodb.org/mongo-driver/mongo"
	"go.uber.org/zap"
)

// DBQuery 数据库查询请求
type DBQuery struct {
	Query    string
	Args     []interface{}
	Callback func(*sql.Rows, error)
}

// DBConnector 数据库连接器接口
type DBConnector interface {
	// Init 初始化数据库连接
	Init(dbConfig config.DBConfig) error
	// Start 启动数据库连接
	Start() error
	// Query 执行查询操作
	Query(sql string, args []interface{}, callback func(*sql.Rows, error))
	// Execute 执行执行操作（插入、更新、删除等）
	Execute(sql string, args []interface{}, callback func(sql.Result, error))
	// Close 关闭数据库连接
	Close() error
	// GetDriver 获取当前数据库驱动类型
	GetDriver() string
	// GetMongoClient 获取MongoDB客户端
	GetMongoClient() *mongo.Client
	// GetMongoDB 获取MongoDB数据库
	GetMongoDB() *mongo.Database
}

// BaseConnector 基础数据库连接器实现
type BaseConnector struct {
	name        string          // 数据库名称
	dbConfig    config.DBConfig // 数据库配置
	driver      string          // 数据库驱动类型
	mu          sync.Mutex      // 互斥锁，用于并发控制
	mongoClient *mongo.Client   // MongoDB客户端
	mongoDB     *mongo.Database // MongoDB数据库
}

// NewDBConnector 创建数据库连接器实例
func NewDBConnector(name string, driver string, capacity int) DBConnector {
	if capacity <= 0 {
		capacity = 1000
	}

	// 根据驱动类型创建不同的数据库连接器
	switch driver {
	case "mongo":
		return NewMongoConnector(name)
	case "mysql":
		return NewMySQLConnector(name, capacity)
	default:
		// 默认使用MySQL驱动
		zLog.GetLogger().Warn("Unknown database driver, using MySQL as default", zap.String("driver", driver))
		return NewMySQLConnector(name, capacity)
	}
}
